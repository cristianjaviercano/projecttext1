<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagnóstico: Formulación y Evaluación de Proyectos</title>
    <meta name="description" content="Evaluación diagnóstica para la Maestría en Ingeniería de Procesos - Universidad de San Buenaventura">
    <meta name="author" content="Ing. Cristian Javier Cano M.">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Fuentes Académicas -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Merriweather:wght@700&display=swap" rel="stylesheet">
    <!-- Iconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* Estilos base */
        body { font-family: 'Roboto', sans-serif; background-color: #f8fafc; color: #334155; }
        h1, h2, h3, .serif { font-family: 'Merriweather', serif; }
        canvas { display: none; }
        .hidden { display: none !important; }
        
        /* Estilos personalizados */
        .option-btn:disabled { cursor: not-allowed; opacity: 0.8; }
        .correct-answer { background-color: #dcfce7 !important; border-color: #22c55e !important; color: #14532d !important; }
        .wrong-answer { background-color: #fee2e2 !important; border-color: #ef4444 !important; color: #7f1d1d !important; }
        
        /* Animaciones */
        .fade-in { animation: fadeIn 0.4s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Gradiente Institucional */
        .usb-gradient { background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%); }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4">

    <!-- Contenedor Principal -->
    <div class="bg-white w-full max-w-6xl rounded-2xl shadow-2xl overflow-hidden relative fade-in flex flex-col" id="mainContainer" style="min-height: 700px;">
        
        <!-- Header / Navbar -->
        <header class="usb-gradient p-6 text-white relative overflow-hidden shadow-md shrink-0">
            <div class="absolute top-0 left-0 w-full h-full opacity-10 pointer-events-none">
                <i class="fas fa-network-wired absolute -left-10 -top-10 text-9xl"></i>
            </div>
            <div class="relative z-10 flex flex-col md:flex-row justify-between items-center gap-4">
                <div class="text-center md:text-left">
                    <h1 class="text-2xl md:text-3xl font-bold tracking-tight">Evaluación Diagnóstica</h1>
                    <p class="text-blue-200 text-sm mt-1 font-light tracking-wider uppercase">Maestría en Ingeniería de Procesos</p>
                </div>
                <!-- Botón de reinicio discreto -->
                <button onclick="location.reload()" class="text-xs bg-white/10 hover:bg-white/20 text-white px-3 py-1 rounded transition backdrop-blur-sm">
                    <i class="fas fa-sync-alt mr-1"></i> Reiniciar
                </button>
            </div>
        </header>

        <!-- PANTALLA 1: LANDING & LOGIN (Grid Layout) -->
        <div id="loginScreen" class="flex-grow grid grid-cols-1 lg:grid-cols-2 h-full fade-in">
            
            <!-- Columna Izquierda: Información del Curso y Docente -->
            <div class="p-8 md:p-12 bg-slate-50 border-r border-slate-200 flex flex-col justify-center">
                
                <!-- Bienvenida -->
                <div class="mb-10">
                    <span class="bg-blue-100 text-blue-800 text-xs font-bold px-3 py-1 rounded-full uppercase tracking-wide mb-3 inline-block">Cohorte IV</span>
                    <h2 class="text-3xl text-slate-800 mb-4 leading-tight">Formulación y Evaluación de Proyectos</h2>
                    <p class="text-slate-600 leading-relaxed">
                        Bienvenido al entorno de evaluación. Este instrumento nos permite identificar sus fortalezas en el ciclo de vida de proyectos, metodologías (MGA, PMI) y análisis financiero para personalizar su experiencia de aprendizaje.
                    </p>
                </div>

                <!-- Tarjeta del Docente -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100 mb-8 flex items-start gap-4 transform transition hover:-translate-y-1 duration-300">
                    <div class="bg-slate-200 h-16 w-16 rounded-full flex items-center justify-center shrink-0 text-slate-400 text-2xl">
                        <i class="fas fa-user-tie"></i>
                    </div>
                    <div>
                        <h3 class="text-lg text-slate-800 font-bold">Ing. Cristian Javier Cano M.</h3>
                        <p class="text-blue-600 text-sm font-medium mb-1">Magíster en Gestión de la Innovación</p>
                        <p class="text-slate-500 text-xs mt-2 italic">"La formulación de proyectos es el puente entre una idea abstracta y una realidad transformadora."</p>
                    </div>
                </div>

                <!-- Reglas de la Prueba -->
                <div>
                    <h4 class="text-sm font-bold text-slate-700 uppercase mb-3 flex items-center">
                        <i class="fas fa-clipboard-list mr-2 text-blue-500"></i> Reglas de la Prueba
                    </h4>
                    <ul class="text-sm text-slate-600 space-y-2 pl-2">
                        <li class="flex items-center"><i class="fas fa-check text-green-500 mr-2 text-xs"></i> <span>Consta de <strong>15 preguntas</strong> de selección múltiple.</span></li>
                        <li class="flex items-center"><i class="fas fa-check text-green-500 mr-2 text-xs"></i> <span>Evalúa componentes de Mercado, Técnico, Legal y Financiero.</span></li>
                        <li class="flex items-center"><i class="fas fa-check text-green-500 mr-2 text-xs"></i> <span>Al finalizar, obtendrá una <strong>Insignia Digital</strong> descargable.</span></li>
                    </ul>
                </div>
            </div>

            <!-- Columna Derecha: Login -->
            <div class="p-8 md:p-12 flex flex-col items-center justify-center bg-white relative">
                <!-- Decoración de fondo -->
                <div class="absolute top-0 right-0 w-32 h-32 bg-blue-50 rounded-bl-full opacity-50 pointer-events-none"></div>

                <div class="w-full max-w-sm">
                    <div class="text-center mb-8">
                        <h3 class="text-xl font-bold text-slate-800">Acceso Estudiantes</h3>
                        <p class="text-slate-400 text-sm">Ingrese sus credenciales para comenzar</p>
                    </div>

                    <form onsubmit="handleLogin(event)" class="space-y-5">
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Estudiante</label>
                            <div class="relative">
                                <i class="fas fa-user absolute left-4 top-3.5 text-slate-400"></i>
                                <select id="userSelect" class="w-full pl-10 pr-4 py-3 rounded-lg border border-slate-200 bg-slate-50 focus:bg-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition appearance-none cursor-pointer text-slate-700" required>
                                    <option value="" disabled selected>Seleccione su nombre...</option>
                                    <!-- Se llena con JS -->
                                </select>
                                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-slate-500">
                                    <i class="fas fa-chevron-down text-xs mr-2"></i>
                                </div>
                            </div>
                        </div>

                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Código de Acceso</label>
                            <div class="relative">
                                <i class="fas fa-key absolute left-4 top-3.5 text-slate-400"></i>
                                <input type="password" id="passwordInput" class="w-full pl-10 pr-4 py-3 rounded-lg border border-slate-200 bg-slate-50 focus:bg-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition text-slate-700" placeholder="Ingrese su código estudiantil" required>
                            </div>
                            <p id="loginError" class="text-red-500 text-xs mt-2 hidden flex items-center animate-pulse"><i class="fas fa-exclamation-circle mr-1"></i> Credenciales incorrectas.</p>
                        </div>

                        <button type="submit" class="w-full bg-blue-700 hover:bg-blue-800 text-white font-bold py-3.5 px-6 rounded-lg transition transform hover:scale-[1.02] shadow-lg shadow-blue-200 flex items-center justify-center mt-6">
                            <span>Iniciar Diagnóstico</span> <i class="fas fa-arrow-right ml-2"></i>
                        </button>
                    </form>
                    
                    <div class="mt-8 pt-6 border-t border-slate-100 text-center">
                        <p class="text-xs text-slate-400">Universidad de San Buenaventura<br>Cartagena, 2026</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- PANTALLA 2: Instrucciones / Transición (Oculta al inicio) -->
        <div id="welcomeScreen" class="hidden flex-grow flex flex-col items-center justify-center p-8 text-center fade-in bg-slate-50">
            <div class="bg-white p-10 rounded-2xl shadow-xl max-w-2xl w-full">
                <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6">
                    <i class="fas fa-play text-3xl text-green-600 pl-1"></i>
                </div>
                <h2 class="text-2xl text-slate-800 mb-2">Hola, <span id="displayUserName" class="text-blue-700 font-bold">Estudiante</span></h2>
                <p class="text-slate-600 mb-8 text-lg">
                    Todo listo. Recuerde leer cuidadosamente cada pregunta. No hay límite de tiempo, pero intente responder con su conocimiento actual sin consultar fuentes externas.
                </p>
                <button onclick="startQuiz()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-12 rounded-full transition transform hover:scale-105 shadow-xl shadow-green-200 text-lg">
                    Comenzar Ahora
                </button>
            </div>
        </div>

        <!-- PANTALLA 3: Admin Dashboard -->
        <div id="adminScreen" class="hidden flex-grow flex-col p-8 fade-in h-full bg-slate-50">
            <div class="flex flex-col md:flex-row justify-between items-center mb-6 pb-4 border-b border-slate-200">
                <div class="mb-4 md:mb-0">
                    <h2 class="text-2xl font-bold text-slate-800"><i class="fas fa-database text-blue-600 mr-2"></i>Resultados Consolidados</h2>
                    <p class="text-slate-500 text-sm">Gestión de calificaciones del grupo</p>
                </div>
                <div class="flex gap-3">
                    <button onclick="clearData()" class="px-4 py-2 text-red-600 border border-red-200 bg-white rounded-lg hover:bg-red-50 text-sm transition font-medium shadow-sm">
                        <i class="fas fa-trash-alt mr-1"></i> Limpiar BD
                    </button>
                    <button onclick="exportTableToCSV()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm transition font-medium shadow-md">
                        <i class="fas fa-file-excel mr-1"></i> Descargar CSV
                    </button>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden flex-grow">
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left text-slate-500">
                        <thead class="text-xs text-slate-700 uppercase bg-slate-50 border-b border-slate-100">
                            <tr>
                                <th scope="col" class="px-6 py-4 font-bold">Estudiante</th>
                                <th scope="col" class="px-6 py-4 font-bold">Código</th>
                                <th scope="col" class="px-6 py-4 text-center font-bold">Puntaje</th>
                                <th scope="col" class="px-6 py-4 text-center font-bold">Nivel</th>
                                <th scope="col" class="px-6 py-4 text-right font-bold">Fecha</th>
                            </tr>
                        </thead>
                        <tbody id="resultsTableBody" class="divide-y divide-slate-100">
                            <!-- Filas generadas por JS -->
                        </tbody>
                    </table>
                </div>
                <div id="noDataMessage" class="hidden p-12 text-center text-slate-400">
                    <i class="fas fa-inbox text-4xl mb-3 opacity-50"></i>
                    <p>No se han registrado intentos de evaluación en este dispositivo.</p>
                </div>
            </div>
        </div>

        <!-- PANTALLA 4: Preguntas (Quiz) -->
        <div id="quizScreen" class="hidden flex-grow flex flex-col h-full fade-in bg-white">
            <!-- Barra de Progreso -->
            <div class="w-full bg-slate-100 h-1.5">
                <div id="progressBar" class="bg-blue-600 h-1.5 transition-all duration-500 ease-out" style="width: 0%"></div>
            </div>

            <div class="p-6 md:p-10 flex-grow overflow-y-auto">
                <div class="flex justify-between items-center mb-6">
                    <span id="topicIndicator" class="text-blue-600 text-xs font-bold uppercase tracking-wider bg-blue-50 px-2 py-1 rounded">Tema: ...</span>
                    <span id="questionCounter" class="text-slate-400 text-sm font-medium">1/15</span>
                </div>

                <h3 id="questionText" class="text-xl md:text-2xl font-bold text-slate-800 mb-8 leading-relaxed max-w-4xl">
                    <!-- Pregunta cargada vía JS -->
                </h3>

                <div id="optionsContainer" class="grid gap-4 max-w-4xl">
                    <!-- Opciones cargadas vía JS -->
                </div>
            </div>

            <div class="p-6 bg-slate-50 border-t border-slate-100 flex justify-end shrink-0">
                <button id="nextBtn" onclick="nextQuestion()" disabled class="bg-slate-300 text-white font-bold py-3 px-8 rounded-lg opacity-70 cursor-not-allowed transition flex items-center">
                    Siguiente <i class="fas fa-chevron-right ml-2 text-xs"></i>
                </button>
            </div>
        </div>

        <!-- PANTALLA 5: Resultados -->
        <div id="resultScreen" class="hidden flex-grow p-8 md:p-12 text-center fade-in bg-slate-50 overflow-y-auto">
            <div class="max-w-4xl mx-auto">
                <div class="inline-block p-3 bg-white rounded-full shadow-sm mb-4">
                    <i class="fas fa-award text-4xl text-yellow-500"></i>
                </div>
                <h2 class="text-3xl font-bold text-slate-800 mb-2">Resultados del Diagnóstico</h2>
                <p id="scoreText" class="text-xl text-blue-600 font-bold mb-8">Calculando...</p>

                <div class="grid md:grid-cols-2 gap-8 items-start">
                    <!-- Columna Feedback -->
                    <div class="text-left space-y-6">
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                            <h4 class="font-bold text-slate-800 mb-2 flex items-center"><i class="fas fa-chart-pie text-blue-500 mr-2"></i> Análisis de Desempeño</h4>
                            <p id="feedbackText" class="text-sm text-slate-600 leading-relaxed">...</p>
                        </div>
                        
                        <div class="bg-blue-50 p-5 rounded-xl border border-blue-100">
                            <h5 class="font-bold text-blue-800 mb-3 text-sm uppercase tracking-wide">Competencias Verificadas</h5>
                            <ul class="text-sm text-blue-700 space-y-2">
                                <li class="flex items-center"><i class="fas fa-check-circle mr-2 opacity-70"></i>Identificación de Proyectos</li>
                                <li class="flex items-center"><i class="fas fa-check-circle mr-2 opacity-70"></i>Matemáticas Financieras</li>
                                <li class="flex items-center"><i class="fas fa-check-circle mr-2 opacity-70"></i>Gestión (PMI/MGA)</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Columna Badge -->
                    <div class="flex flex-col items-center justify-center bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                        <p class="text-xs font-bold text-slate-400 mb-4 uppercase tracking-widest">Insignia Oficial</p>
                        
                        <!-- Imagen del Badge -->
                        <div class="relative group cursor-pointer transition transform hover:scale-105 duration-300">
                            <img id="badgeImage" class="w-full max-w-[300px] h-auto shadow-xl rounded-lg border-4 border-white" alt="Generando certificado..." />
                            <div class="absolute inset-0 bg-black/5 rounded-lg border-4 border-transparent"></div>
                        </div>
                        
                        <a id="downloadLink" href="#" download="Insignia_Diagnostico.png" class="mt-6 w-full inline-flex justify-center items-center bg-blue-700 hover:bg-blue-800 text-white font-bold py-3 px-6 rounded-lg shadow-lg shadow-blue-200 transition">
                            <i class="fas fa-download mr-2"></i> Descargar Imagen
                        </a>
                        <p class="text-xs text-slate-400 mt-3">Guarde esta imagen para su portafolio.</p>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Canvas Oculto para Generación de Badge -->
    <canvas id="badgeCanvas" width="800" height="600"></canvas>

    <script>
        // --- BASE DE DATOS DE USUARIOS ---
        const users = [
            { name: "Administrador", code: "581806", role: "admin" },
            { name: "HERRERA GUZMAN, ALCIDES", code: "30000140534", role: "student" },
            { name: "SANABRIA CUCUNUVA, JAVIER RONALDO", code: "30000150491", role: "student" },
            { name: "MADRID GUERRA, JUAN PABLO", code: "30000147966", role: "student" },
            { name: "QUINTANA CANABAL, DAVID FELIPE", code: "30000140458", role: "student" },
            { name: "CERVANTES BALLESTAS, JARLIN JOSE", code: "30000148786", role: "student" },
            { name: "LARIOS TORRES, JHONNY JUNIOR", code: "30000063973", role: "student" },
            { name: "VALIENTE PAJARO, JEISON", code: "30000150577", role: "student" },
            { name: "LAITANO MARTINEZ, JOSUE DAVID", code: "30000150445", role: "student" }
        ];

        // --- BASE DE DATOS DE PREGUNTAS (15 Ítems) ---
        const questions = [
            { id: 1, topic: "Ciclo del Proyecto", question: "En el ciclo de vida de un proyecto, ¿cuál es el objetivo principal de la etapa de 'Pre-factibilidad'?", options: ["Diseñar los planos finales de construcción.", "Evaluar alternativas viables con información secundaria para descartar las no rentables.", "Operar el proyecto para generar ingresos.", "Realizar el acta de constitución del proyecto."], answer: 1, points: 5 },
            { id: 2, topic: "Identificación (MGA)", question: "Según la metodología del Marco Lógico y la MGA, el 'Árbol de Problemas' tiene como función principal:", options: ["Definir los objetivos de rentabilidad.", "Identificar la relación causal entre las raíces (causas), el tronco (problema central) y las ramas (efectos).", "Listar los recursos financieros necesarios.", "Crear el cronograma de actividades."], answer: 1, points: 5 },
            { id: 3, topic: "Estudio de Mercado", question: "¿Qué representa la 'Demanda Insatisfecha' en un estudio de mercado?", options: ["La cantidad de bienes que los consumidores no pueden comprar por falta de dinero.", "La parte del mercado que la oferta actual no cubre y que el proyecto podría captar.", "El total de ventas de la competencia.", "La demanda futura proyectada sin considerar precios."], answer: 1, points: 5 },
            { id: 4, topic: "Estudio Técnico", question: "Al determinar el 'Tamaño del Proyecto', ¿cuál factor suele ser una restricción determinante?", options: ["El color del logotipo.", "La disponibilidad de materias primas e insumos en la localización elegida.", "El nombre del gerente del proyecto.", "La metodología de evaluación ex-post."], answer: 1, points: 5 },
            { id: 5, topic: "Matemáticas Financieras", question: "Si el Valor Presente Neto (VPN) de un proyecto es igual a cero (VPN = 0), esto significa que:", options: ["El proyecto pierde dinero.", "El proyecto no es viable.", "El proyecto recupera la inversión y renta exactamente lo mismo que la Tasa de Oportunidad (TIO).", "El proyecto genera ganancias extraordinarias."], answer: 2, points: 10 },
            { id: 6, topic: "Indicadores Financieros", question: "La Tasa Interna de Retorno (TIR) se define técnicamente como:", options: ["La tasa de interés que cobra el banco.", "La rentabilidad promedio del mercado.", "La tasa de descuento que hace que el VPN sea igual a cero.", "El porcentaje de utilidad neta sobre ventas."], answer: 2, points: 10 },
            { id: 7, topic: "Evaluación Económica", question: "¿Cuál es la principal diferencia entre la Evaluación Financiera (Privada) y la Evaluación Económica (Social)?", options: ["No hay diferencia, son lo mismo.", "La financiera usa precios de mercado y la económica usa precios cuenta (sombra) para medir el bienestar social.", "La financiera es para el gobierno y la económica para privados.", "La financiera no paga impuestos."], answer: 1, points: 10 },
            { id: 8, topic: "Gerencia (PMI)", question: "Según el PMBOK, ¿cuál es el documento que autoriza formalmente la existencia de un proyecto?", options: ["El Cronograma (Gantt).", "El Presupuesto.", "El Acta de Constitución del Proyecto (Project Charter).", "El Análisis de Riesgos."], answer: 2, points: 5 },
            { id: 9, topic: "Estudio Legal", question: "¿Por qué es crítico el estudio legal en la etapa de formulación?", options: ["Para contratar a los abogados más caros.", "Para determinar la viabilidad normativa (uso de suelos, ambiental) antes de realizar inversiones mayores.", "Para demandar a la competencia.", "Para redactar los correos electrónicos."], answer: 1, points: 5 },
            { id: 10, topic: "Costos e Inversiones", question: "¿Qué diferencia existe entre Inversión (CAPEX) y Costo Operativo (OPEX)?", options: ["La Inversión ocurre antes de operar (activos); el Costo Operativo es recurrente durante la producción.", "La inversión es menor que el costo.", "El costo operativo se recupera con la venta de activos.", "No existe diferencia contable."], answer: 0, points: 5 },
            { id: 11, topic: "Identificación de Proyectos", question: "En la construcción del Árbol de Objetivos, las 'Causas' del problema central se transforman en:", options: ["Fines.", "Medios (Objetivos Específicos).", "Indicadores de Gestión.", "Supuestos."], answer: 1, points: 5 },
            { id: 12, topic: "Riesgos", question: "El Análisis de Sensibilidad en la evaluación financiera busca:", options: ["Saber qué sienten los empleados.", "Medir cómo cambia la rentabilidad (VPN/TIR) si varían variables críticas (precio, costos).", "Calcular los impuestos exactos.", "Determinar la ubicación geográfica."], answer: 1, points: 10 },
            { id: 13, topic: "Estudio Administrativo", question: "¿Qué define el 'Organigrama' en el estudio administrativo?", options: ["El flujo de caja.", "La estructura jerárquica y las líneas de autoridad/responsabilidad.", "El proceso productivo de la maquinaria.", "La lista de proveedores."], answer: 1, points: 5 },
            { id: 14, topic: "Evaluación Ex-Post", question: "¿Cuál es el propósito de la Evaluación Ex-Post?", options: ["Detener el proyecto.", "Pedir más dinero al banco.", "Verificar si se lograron los objetivos e impactos previstos una vez finalizado u operando.", "Calcular el presupuesto inicial."], answer: 2, points: 5 },
            { id: 15, topic: "Flujo de Caja", question: "Para calcular el Flujo de Caja Libre, a la Utilidad Operativa después de impuestos se le debe:", options: ["Restar los costos fijos.", "Sumar la Depreciación y Amortización (pues no son salidas reales de efectivo).", "Restar las ventas.", "Sumar los intereses."], answer: 1, points: 10 }
        ];

        // --- ESTADO Y VARIABLES ---
        let currentUser = null;
        let currentQuestionIndex = 0;
        let score = 0;
        const maxScore = questions.reduce((acc, curr) => acc + curr.points, 0); 

        // --- INICIALIZACIÓN ---
        document.addEventListener('DOMContentLoaded', () => {
            loadUserSelect();
        });

        function loadUserSelect() {
            const select = document.getElementById('userSelect');
            const sortedUsers = [...users].sort((a,b) => {
                if(a.role === 'admin') return -1;
                if(b.role === 'admin') return 1;
                return a.name.localeCompare(b.name);
            });

            sortedUsers.forEach(u => {
                const option = document.createElement('option');
                option.value = u.code; 
                option.text = u.name;
                select.appendChild(option);
            });
        }

        // --- LÓGICA DE LOGIN ---
        function handleLogin(e) {
            e.preventDefault();
            const selectedCode = document.getElementById('userSelect').value;
            const inputCode = document.getElementById('passwordInput').value.trim();
            const errorMsg = document.getElementById('loginError');

            if (!selectedCode) {
                errorMsg.classList.remove('hidden'); return;
            }

            if (selectedCode === inputCode) {
                currentUser = users.find(u => u.code === selectedCode);
                errorMsg.classList.add('hidden');
                document.getElementById('loginScreen').classList.add('hidden');
                
                if (currentUser.role === 'admin') {
                    showAdminDashboard();
                } else {
                    showWelcomeScreen();
                }
            } else {
                errorMsg.classList.remove('hidden');
                document.getElementById('passwordInput').value = '';
            }
        }

        function showWelcomeScreen() {
            // Formatear nombre (Primera letra mayúscula, resto minúscula para visualización amigable)
            let rawName = currentUser.name.split(',')[1] || currentUser.name;
            let friendlyName = rawName.trim().toLowerCase().replace(/\b\w/g, c => c.toUpperCase());
            
            document.getElementById('displayUserName').innerText = friendlyName;
            document.getElementById('welcomeScreen').classList.remove('hidden');
        }

        function startQuiz() {
            document.getElementById('welcomeScreen').classList.add('hidden');
            document.getElementById('quizScreen').classList.remove('hidden');
            currentQuestionIndex = 0;
            score = 0;
            renderQuestion();
        }

        // --- LÓGICA DEL QUIZ ---
        function renderQuestion() {
            const q = questions[currentQuestionIndex];
            
            document.getElementById('topicIndicator').innerText = `Tema: ${q.topic}`;
            document.getElementById('questionCounter').innerText = `Pregunta ${currentQuestionIndex + 1} de ${questions.length}`;
            document.getElementById('questionText').innerText = q.question;
            
            const progress = ((currentQuestionIndex) / questions.length) * 100;
            document.getElementById('progressBar').style.width = `${progress}%`;

            const optionsContainer = document.getElementById('optionsContainer');
            optionsContainer.innerHTML = '';
            
            const nextBtn = document.getElementById('nextBtn');
            nextBtn.disabled = true;
            nextBtn.classList.add('opacity-70', 'cursor-not-allowed', 'bg-slate-300');
            nextBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700', 'shadow-lg');

            q.options.forEach((opt, index) => {
                const btn = document.createElement('button');
                btn.className = "option-btn w-full text-left p-4 rounded-xl border-2 border-slate-100 hover:border-blue-200 hover:bg-blue-50/50 transition duration-200 flex items-center group bg-white text-slate-600";
                btn.onclick = () => selectOption(index, btn);
                
                const icon = document.createElement('i');
                icon.className = "far fa-circle text-slate-300 mr-4 group-hover:text-blue-500 text-lg transition-colors";
                
                const span = document.createElement('span');
                span.innerText = opt;
                span.className = "font-medium";

                btn.appendChild(icon);
                btn.appendChild(span);
                optionsContainer.appendChild(btn);
            });
        }

        function selectOption(selectedIndex, btnElement) {
            const buttons = document.getElementById('optionsContainer').getElementsByTagName('button');
            for (let btn of buttons) {
                btn.disabled = true;
                btn.classList.add('opacity-60');
            }
            btnElement.classList.remove('opacity-60');

            const q = questions[currentQuestionIndex];
            const isCorrect = selectedIndex === q.answer;

            if (isCorrect) {
                btnElement.classList.add('correct-answer', 'ring-2', 'ring-green-400', 'ring-offset-1');
                btnElement.querySelector('i').className = "fas fa-check-circle text-green-600 mr-4 text-lg";
                score += q.points;
            } else {
                btnElement.classList.add('wrong-answer', 'ring-2', 'ring-red-400', 'ring-offset-1');
                btnElement.querySelector('i').className = "fas fa-times-circle text-red-600 mr-4 text-lg";
                
                const correctBtn = buttons[q.answer];
                correctBtn.classList.remove('opacity-60');
                correctBtn.classList.add('correct-answer');
                correctBtn.querySelector('i').className = "fas fa-check-circle text-green-600 mr-4 text-lg";
            }

            const nextBtn = document.getElementById('nextBtn');
            nextBtn.disabled = false;
            nextBtn.classList.remove('opacity-70', 'cursor-not-allowed', 'bg-slate-300');
            nextBtn.classList.add('bg-blue-600', 'hover:bg-blue-700', 'shadow-lg', 'text-white');
            
            if(currentQuestionIndex === questions.length - 1) {
                nextBtn.innerHTML = 'Ver Resultados <i class="fas fa-flag-checkered ml-2"></i>';
            }
        }

        function nextQuestion() {
            currentQuestionIndex++;
            if (currentQuestionIndex < questions.length) {
                renderQuestion();
            } else {
                finishQuiz();
            }
        }

        function finishQuiz() {
            document.getElementById('quizScreen').classList.add('hidden');
            document.getElementById('resultScreen').classList.remove('hidden');

            const percentage = (score / maxScore) * 100;
            const scoreDisplay = document.getElementById('scoreText');
            const feedbackDisplay = document.getElementById('feedbackText');

            scoreDisplay.innerText = `Puntaje Final: ${score} / ${maxScore} (${percentage.toFixed(0)}%)`;

            let feedback = "", rank = "", color = "";

            if (percentage >= 90) {
                feedback = "¡Excelente desempeño! Demuestra un dominio sólido de los conceptos de formulación y evaluación. Está listo para profundizar en el modelado avanzado.";
                rank = "EXPERTO";
                color = "#EAB308"; // Yellow-500
            } else if (percentage >= 70) {
                feedback = "Buen trabajo. Conoce los fundamentos y metodologías clave. Se recomienda reforzar los conceptos de indicadores financieros (VPN, TIR).";
                rank = "AVANZADO";
                color = "#94A3B8"; // Slate-400
            } else {
                feedback = "Inicio del camino de aprendizaje. Es fundamental repasar la metodología MGA y la estructura básica del estudio de mercado.";
                rank = "INICIAL";
                color = "#B45309"; // Amber-700
            }
            feedbackDisplay.innerText = feedback;

            saveResultToStorage(currentUser.name, currentUser.code, score, rank);
            setTimeout(() => generateBadge(currentUser.name, percentage, rank, color), 500);
        }

        function saveResultToStorage(name, code, score, rank) {
            const result = {
                name: name,
                code: code,
                score: score,
                rank: rank,
                date: new Date().toLocaleString()
            };
            let allResults = JSON.parse(localStorage.getItem('quiz_results_db')) || [];
            allResults.push(result);
            localStorage.setItem('quiz_results_db', JSON.stringify(allResults));
        }

        // --- DASHBOARD ADMIN ---
        function showAdminDashboard() {
            document.getElementById('adminScreen').classList.remove('hidden');
            const tableBody = document.getElementById('resultsTableBody');
            const noDataMsg = document.getElementById('noDataMessage');
            
            const results = JSON.parse(localStorage.getItem('quiz_results_db')) || [];
            tableBody.innerHTML = '';
            
            if (results.length === 0) {
                noDataMsg.classList.remove('hidden'); return;
            } else {
                noDataMsg.classList.add('hidden');
            }

            results.forEach(r => {
                const row = document.createElement('tr');
                row.className = "bg-white border-b hover:bg-slate-50 transition";
                
                let scoreClass = r.score >= 80 ? 'text-green-600 bg-green-50' : (r.score >= 60 ? 'text-blue-600 bg-blue-50' : 'text-red-600 bg-red-50');

                row.innerHTML = `
                    <td class="px-6 py-4 font-medium text-slate-700 whitespace-nowrap">${r.name}</td>
                    <td class="px-6 py-4 font-mono text-xs text-slate-500">${r.code}</td>
                    <td class="px-6 py-4 text-center"><span class="${scoreClass} px-2 py-1 rounded font-bold">${r.score}</span></td>
                    <td class="px-6 py-4 text-center text-xs"><span class="bg-slate-100 text-slate-600 border border-slate-200 py-1 px-3 rounded-full font-medium">${r.rank}</span></td>
                    <td class="px-6 py-4 text-right text-xs text-slate-400">${r.date}</td>
                `;
                tableBody.appendChild(row);
            });
        }

        function clearData() {
            if(confirm("¿Está seguro de borrar todos los resultados almacenados en este navegador?")) {
                localStorage.removeItem('quiz_results_db');
                showAdminDashboard();
            }
        }
        
        function exportTableToCSV() {
            const results = JSON.parse(localStorage.getItem('quiz_results_db')) || [];
            if(results.length === 0) { alert("No hay datos para exportar"); return; }
            
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "Nombre,Codigo,Puntaje,Nivel,Fecha\n";
            results.forEach(r => {
                csvContent += `"${r.name}","${r.code}",${r.score},${r.rank},"${r.date}"\n`;
            });
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "Resultados_Diagnostico.csv");
            document.body.appendChild(link);
            link.click();
        }

        // --- BADGE GENERATOR ---
        function generateBadge(name, percentage, rank, accentColor) {
            const canvas = document.getElementById('badgeCanvas');
            const ctx = canvas.getContext('2d');
            
            // Asegurar dimensiones
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Fondo con Gradiente
            const gradient = ctx.createLinearGradient(0, 0, 0, 600);
            gradient.addColorStop(0, '#1e3a8a'); 
            gradient.addColorStop(1, '#1e40af'); 
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, 800, 600);
            
            // Patrón sutil (opcional, líneas)
            ctx.strokeStyle = "rgba(255,255,255,0.05)";
            ctx.lineWidth = 1;
            for(let i=0; i<800; i+=40) {
                ctx.beginPath(); ctx.moveTo(i,0); ctx.lineTo(i,600); ctx.stroke();
            }

            // Marco Dorado/Plateado/Bronce
            ctx.lineWidth = 12;
            ctx.strokeStyle = accentColor;
            ctx.strokeRect(40, 40, 720, 520);
            
            ctx.lineWidth = 2;
            ctx.strokeStyle = "rgba(255,255,255,0.2)";
            ctx.strokeRect(55, 55, 690, 490);

            // Títulos
            ctx.textAlign = 'center';
            ctx.fillStyle = '#ffffff';
            ctx.font = 'bold 32px Merriweather'; 
            ctx.fillText('CERTIFICADO DE COMPETENCIA', 400, 130);
            
            ctx.font = '24px Roboto';
            ctx.fillStyle = '#93c5fd'; 
            ctx.fillText('Formulación y Evaluación de Proyectos', 400, 170);

            ctx.font = 'italic 20px Roboto';
            ctx.fillStyle = '#cbd5e1';
            ctx.fillText('Otorgado a:', 400, 240);

            // Nombre del Estudiante
            ctx.font = 'bold 38px Roboto';
            ctx.fillStyle = '#ffffff';
            // Ajuste dinámico de fuente si es muy largo
            if (name.length > 25) ctx.font = 'bold 30px Roboto';
            ctx.fillText(name, 400, 290);

            // Separador
            ctx.beginPath();
            ctx.moveTo(250, 320);
            ctx.lineTo(550, 320);
            ctx.strokeStyle = accentColor;
            ctx.lineWidth = 3;
            ctx.stroke();

            // Puntaje Grande
            ctx.font = 'bold 70px Roboto';
            ctx.fillStyle = accentColor;
            ctx.fillText(`${percentage.toFixed(0)}%`, 400, 410);

            ctx.font = '18px Roboto';
            ctx.fillStyle = '#e2e8f0';
            ctx.fillText('NIVEL DE DESEMPEÑO', 400, 450);
            
            ctx.font = 'bold 32px Roboto';
            ctx.fillStyle = '#ffffff';
            ctx.fillText(rank, 400, 490);

            // Firma / Fecha
            const date = new Date().toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric' });
            ctx.font = '16px Roboto';
            ctx.fillStyle = '#94a3b8';
            ctx.fillText(`Emitido el: ${date}`, 400, 550);
            ctx.fillText(`Ing. Cristian Javier Cano M. - Docente`, 400, 575);

            try {
                const dataURL = canvas.toDataURL('image/png');
                document.getElementById('badgeImage').src = dataURL;
                document.getElementById('downloadLink').href = dataURL;
            } catch (e) {
                console.error("Canvas error:", e);
            }
        }
    </script>
</body>
</html>
